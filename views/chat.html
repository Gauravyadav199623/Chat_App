<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script  defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <style>
        #messageForm {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: space-between;
            width: 80%;
        }
        #chatBox {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            /* background-color: black; */
        }
        .message {
            margin: 5px 0;
        }
        .userMessage {
            color: #007bff;
        }
        .otherMessage {
            color: #28a745;
        }
        #messageInput {
            flex-grow: 1;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="chatBox"></div>
    <form id="messageForm">
        <input id="messageInput" type="text" name="message" placeholder="Type your message...">
        <button type="submit">Send</button>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        const chatBox = document.getElementById('chatBox');
    const messageForm = document.getElementById('messageForm');
    const userId = parseJwt(token).userId;

   const fetchChatData = async () => {
            try {
                // Retrieve messages from local storage
                const localMessages = getMessagesFromLocal();
                console.log(localMessages);
                

                // Fetch new messages from the backend since the latest local message
                const latestLocalMessageTimestamp = getLatestLocalMessageTimestamp(localMessages);
                const response = await axios.get('getChatData', { headers: { "Authorization": token, "Latest-Local-Timestamp": latestLocalMessageTimestamp } });

                // Combine local and new messages
                const allMessages = [...localMessages, ...response.data.chat];

                // Save all messages to local storage
                saveMessagesToLocal(allMessages);

                // Update the chatBox with all messages
                chatBox.innerHTML = '';
                allMessages.forEach(msg => {
                    const sender = msg.userId === userId ? 'You' : msg.user.name;
                    const messageClass = msg.userId === userId ? 'userMessage' : 'otherMessage';
                    const messageHTML = `<p class="message ${messageClass}"><strong>${sender}:</strong> ${msg.message}</p>`;
                    chatBox.innerHTML += messageHTML;
                });

                // Scroll to the bottom of the chatBox to show the latest messages
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error('Error fetching chat data:', error);
            }
        };

        // Function to retrieve messages from local storage
        const getMessagesFromLocal = () => {
            const storedMessages = localStorage.getItem('chatMessages');
            return storedMessages ? JSON.parse(storedMessages) : [];
        };

        // Function to get the timestamp of the latest local message
        const getLatestLocalMessageTimestamp = (messages) => {
            if (messages.length > 0) {
                console.log(messages[messages.length - 1].createdAt+".......messages[messages.length - 1].createdAt");
                return messages[messages.length - 1].createdAt;
            }
            return null;
        };

        // Function to save messages to local storage
const saveMessagesToLocal = (newMessages) => {
    // Retrieve existing messages from local storage
    const storedMessages = getMessagesFromLocal();

    // Check if each new message already exists in the stored messages
    const uniqueNewMessages = newMessages.filter(newMsg => {
        const isNewMessage = !storedMessages.some(storedMsg => storedMsg.id === newMsg.id);
        return isNewMessage;
    });
//     const uniqueNewMessages = [];

// for (let i = 0; i < newMessages.length; i++) {
//     let isNewMessage = true;
//     for (let j = 0; j < storedMessages.length; j++) {
//         if (storedMessages[j].id === newMessages[i].id) {
//             isNewMessage = false;
//             break;
//         }
//     }
//     if (isNewMessage) {
//         uniqueNewMessages.push(newMessages[i]);
//     }
// }


    // Combine existing and unique new messages
    const allMessages = [...storedMessages, ...uniqueNewMessages];
    console.log(allMessages,".....allMessages");

    // Save the combined messages to local storage
    localStorage.setItem('chatMessages', JSON.stringify(allMessages));
};

        // Call the fetchChatData function on page load
        fetchChatData();

        // Event listener for submitting messages
        messageForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (message === '') {
                return; // Don't send empty messages
            }

            try {
                // Send new message to the backend
                const res = await axios.post('/postChat', { message }, { headers: { "Authorization": token } });
                if (res.status === 201) {
                    console.log(res.data, "data..............");
                    // Fetch updated chat data after sending the message
                    fetchChatData();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
            messageInput.value = '';
        });
    </script>
</body>
</html>