<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script  defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <style>
        #messageForm {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: space-between;
            width: 80%;
        }
        #chatBox {
            /* Container for the chat messages */
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .message {
            /* Style for each message */
            margin: 5px 0;
        }
        .userMessage {
            /* Style for messages sent by the user */
            color: #007bff;
        }
        .otherMessage {
            /* Style for messages sent by others */
            color: #28a745;
        }
        #messageInput {
            /* Changed ID for the input field */
            flex-grow: 1;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="chatBox"></div>
    <form id="messageForm">
        <input id='name' type='hidden' name='name'>
        <input id='messageInput' type='text' name='message'>
        <button type='submit'>Send</button>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>

    <script>
        
        const token=localStorage.getItem('token')
function parseJwt (token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));

    return JSON.parse(jsonPayload);
}
        const chatBox = document.getElementById('chatBox');
        const messageForm = document.getElementById('messageForm');

    
const fetchChatData = async () => {
    try {
        const response = await axios.get('getChatData', { headers: { "Authorization": token } });
        const user = response.data.user;
        const decodedToken = parseJwt(token);

        console.log(user);
        console.log(response.data);
        console.log(decodedToken, "decodedToken");
        const userId=response.data.user.id

        // Update the chatBox with the received messages
        chatBox.innerHTML = '';

        response.data.chat.forEach(msg => {
            const sender = userId === user.id ? user.name : msg.User.name;
            const messageClass = userId === user.id ? 'userMessage' : 'otherMessage';

            const messageHTML = `<p class="message ${messageClass}"><strong>${sender}:</strong> ${msg.message}</p>`;
            chatBox.innerHTML += messageHTML;
        });

        // Scroll to the bottom of the chatBox to show the latest messages
        chatBox.scrollTop = chatBox.scrollHeight;
    } catch (error) {
        console.error('Error fetching chat data:', error);
    }
};





        // Call the fetchChatData function on page load
        fetchChatData();

        // Event listener for submitting messages
        messageForm.addEventListener('submit', async function (event) {
            event.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;

            if (message.trim() === '') {
                return; // Don't send empty messages
            }

            // // Add the message to the chatBox with the username
            // chatBox.innerHTML += '<p class="message userMessage"><strong>' + name + ':</strong> ' + message + '</p>';

            // // Clear the input field
            // messageInput.value = '';

            // Handle the message sending logic here (e.g., using axios)
            try {
                const res = await axios.post('/postChat', {  message },{headers:{"Authorization":token}}); // Include the 'type' property
; // Adjust the endpoint
                if (res.status === 201) {
                    console.log(res.data);
                    // Fetch updated chat data after sending the message
                    fetchChatData();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
            messageInput.value = '';
        });
    </script>
</body>
</html>
